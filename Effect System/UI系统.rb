#==============================================================================
# ■ UI系统 by 老鹰（http://oneeyedeagle.lofter.com/）
#==============================================================================
$imported ||= {}
$imported["EAGLE-UISystem"] = true
#=============================================================================
# - 2019.10.24.19 初稿
#=============================================================================
# - 本插件提供了对简单UI精灵的生成及控制
#-----------------------------------------------------------------------------
# - 生成并绑定新的UI精灵（在Scene切换时自动释放）
#      s = EAGLE_UI.new(sym, params)
#   其中 s 为所生成的UI精灵
#   其中 sym 为该UI精灵的唯一标识符
#   其中 params 为下列参数的Hash
#
# - 获取指定 sym 的UI精灵，并赋值给变量 s（若无精灵，则返回 nil）
#      s = EAGLE_UI.get(sym)
#
# - UI精灵的实例方法：
#     .active  → 获取当前按键判定状态
#     .active=(flag) → 设置按键判定的允许状态为flag
#     .bind_key(sym, method) → 绑定按下对应键时调用的方法（sym为常量中的绑定符号）
#              其中 method 方法的参数为UI精灵实例
#
#=============================================================================

module EAGLE_UI
  #--------------------------------------------------------------------------
  # ● 【常量】按键对应
  #--------------------------------------------------------------------------
  BUTTONS = {
    # 绑定的符号 => 判定按键的符号
    :OK => :C,
    :CANCEL => :B,
    :ST => :A,
  }
  #--------------------------------------------------------------------------
  # ● 按键判定成功？
  #--------------------------------------------------------------------------
  def self.trigger?(sym_bind, sprite)
    sym = BUTTONS[sym_bind]
    if sym.is_a?(Symbol)
      return Input.trigger?(sym)
    else
      return false
    end
  end
  #--------------------------------------------------------------------------
  # ● 生成新的UI精灵
  #--------------------------------------------------------------------------
  def self.new(sym, params)
    s = Eagle_UI_Sprite.new(nil, params)
    @uis[sym].dispose if @uis[sym]
    @uis[sym] = s
    s
  end
  #--------------------------------------------------------------------------
  # ● 获取UI精灵
  #--------------------------------------------------------------------------
  def self.get(sym)
    @uis[sym]
  end
  #--------------------------------------------------------------------------
  # ● 初始化
  #--------------------------------------------------------------------------
  def self.init
    @uis = {} # sym => Sprite
  end
  #--------------------------------------------------------------------------
  # ● 更新
  #--------------------------------------------------------------------------
  def self.update
    @uis.each { |s| s.update }
  end
  #--------------------------------------------------------------------------
  # ● 清除
  #--------------------------------------------------------------------------
  def self.clear
    @uis.each { |s| s.dispose }
    @uis.clear
  end
end
#=============================================================================
# ○ UI精灵
#=============================================================================
class Eagle_UI_Sprite < Sprite
  attr_reader :active, :params
  #--------------------------------------------------------------------------
  # ● 初始化
  #--------------------------------------------------------------------------
  def initialize(viewport, params)
    super(viewport)
    @params = params
    @event_list = {}
    @active = true # 激活中？
    @key_list = {}
  end
  #--------------------------------------------------------------------------
  # ● 更新
  #--------------------------------------------------------------------------
  def update
    super
    update_key if @active
  end
  #--------------------------------------------------------------------------
  # ● 释放
  #--------------------------------------------------------------------------
  def dispose
    super
    self.bitmap.dispose if self.bitmap
  end
  #--------------------------------------------------------------------------
  # ● 绑定按键
  #--------------------------------------------------------------------------
  def bind_key(sym, method)
    @key_list[sym] = method
  end
  #--------------------------------------------------------------------------
  # ● 更新按键
  #--------------------------------------------------------------------------
  def update_key
    @key_list.each { |sym, m| m.call(self) if EAGLE_UI.trigger?(sym, self) }
  end

  #--------------------------------------------------------------------------
  # ● 绑定方法
  #--------------------------------------------------------------------------
  def bind(sym, method)
    @event_list[sym] = method
  end
  #--------------------------------------------------------------------------
  # ● 呼叫方法
  #--------------------------------------------------------------------------
  def call(sym, *params)
    @event_list[sym].call(*params) if @event_list[sym]
  end
end
#=============================================================================
# ○ 绑定
#=============================================================================
class << DataManager
  #--------------------------------------------------------------------------
  # ● 初始化模块
  #--------------------------------------------------------------------------
  alias eagle_eui_init init
  def init
    eagle_eui_init
    EAGLE_UI.init
  end
end
class Scene_Base
  #--------------------------------------------------------------------------
  # ● 基础更新
  #--------------------------------------------------------------------------
  alias eagle_eui_update_basic update_basic
  def update_basic
    eagle_eui_update_basic
    EAGLE_UI.update
  end
  #--------------------------------------------------------------------------
  # ● 结束处理
  #--------------------------------------------------------------------------
  alias eagle_eui_terminate terminate
  def terminate
    eagle_eui_terminate
    EAGLE_UI.clear
  end
end
