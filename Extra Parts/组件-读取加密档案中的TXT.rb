#==============================================================================
# ■ 组件-读取加密档案中的TXT by 老鹰（https://github.com/OneEyedEagle/EAGLE-RGSS3）
#==============================================================================
$imported ||= {}
$imported["EAGLE-LoadTXT"] = "1.0.0"
#==============================================================================
# - 2020.5.28.14
#==============================================================================
# - 本插件定义了能够读取加密档案中的 TXT 文件（UTF-8编码）的 EAGLE.load_text 方法，
# - 请将本插件放置于其他老鹰的插件之上
#==============================================================================

#==============================================================================
# ○ 【读取部分】
#==============================================================================
module EAGLE
  #--------------------------------------------------------------------------
  # ● 读取TXT文本（UTF-8编码）
  #--------------------------------------------------------------------------
  def self.load_text(filename)
    t = Packaged.read_data(filename)
    t.force_encoding("utf-8")
    t.encode("utf-8")
  end
end

#==============================================================================
# ○ 核心 by Fux2
#  from http://rpg.blue/thread-341724-1-1.html
#==============================================================================
module Packaged
  #--------------------------------------------------------------------------
  # ● 读取数据
  #--------------------------------------------------------------------------
  def self.read_data(name)
    x = Marshal.method(:load)
    y = class << Marshal; self; end
    y.send(:define_method, :load){|a, *b| a.respond_to?(:read) ? a.read : a.to_s}
    ret = nil
    begin
      ret = load_data(name)
    ensure
      y.send(:define_method, :load, x)
    end
    ret
  end
end
