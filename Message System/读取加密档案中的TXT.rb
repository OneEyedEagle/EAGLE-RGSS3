#==============================================================================
# ■ 读取加密档案中的TXT by 老鹰（http://oneeyedeagle.lofter.com/）
#==============================================================================
# - 2019.9.18.15
#==============================================================================
# - 本插件覆盖了 EAGLE.load_text 方法，
#   使其能够读取加密档案中的 TXT 文件（UTF-8编码）
#
# - 将本插件放置于定义了 EAGLE.load_text 方法的插件之下，即可完美兼容
#   如 【Add-On 并行对话 by 老鹰】
#==============================================================================

#==============================================================================
# ○ 【读取部分】
#==============================================================================
module EAGLE
  #--------------------------------------------------------------------------
  # ● 读取TXT文本（UTF-8编码）
  #--------------------------------------------------------------------------
  def self.load_text(filename)
    t = Packaged.read_data(filename)
    t.force_encoding("utf-8")
    t.encode("utf-8")
  end
end

#==============================================================================
# ○ 核心 by Fux2
#  from http://rpg.blue/thread-341724-1-1.html
#==============================================================================
module Packaged
  #--------------------------------------------------------------------------
  # ● 读取数据
  #--------------------------------------------------------------------------
  def self.read_data(name)
    x = Marshal.method(:load)
    y = class << Marshal; self; end
    y.send(:define_method, :load){|a, *b| a.respond_to?(:read) ? a.read : a.to_s}
    ret = nil
    begin
      ret = load_data(name)
    ensure
      y.send(:define_method, :load, x)
    end
    ret
  end
end
